<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Inventaire – Le Vauban</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #0b1120;
      color: #e5e7eb;
    }
    header {
      padding: 12px 16px;
      background: #020617;
      border-bottom: 1px solid #1f2937;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }
    header h1 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
    }
    main {
      padding: 12px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    th, td {
      border-bottom: 1px solid #1f2937;
      padding: 4px 6px;
      vertical-align: middle;
    }
    th {
      background: #020617;
      text-align: left;
      font-weight: 500;
    }
    input[type="text"],
    input[type="number"] {
      width: 100%;
      box-sizing: border-box;
      font-size: 0.8rem;
      padding: 2px 4px;
      border-radius: 4px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
    }
    input[type="number"] {
      text-align: right;
    }
    button {
      font-size: 0.75rem;
      padding: 4px 6px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn-primary {
      background: #facc15;
      color: #111827;
      font-weight: 600;
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid #4b5563;
      color: #e5e7eb;
    }
    #inv-info {
      font-size: 0.8rem;
      margin-bottom: 6px;
      color: #9ca3af;
    }
    #inv-msg {
      font-size: 0.75rem;
      margin-top: 6px;
      color: #e5e7eb;
      white-space: pre-wrap;
      word-break: break-word;
    }
    tfoot th {
      background: #020617;
      border-top: 1px solid #1f2937;
    }
    #inv-total {
      font-weight: 700;
    }
    .add-row {
      margin-top: 16px;
      padding-top: 8px;
      border-top: 1px solid #1f2937;
    }
    .add-row h2 {
      margin: 0 0 6px;
      font-size: 0.9rem;
      font-weight: 500;
    }
    .add-row-fields {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .add-row-fields input {
      min-width: 90px;
      flex: 1 1 120px;
    }
    @media (max-width: 600px) {
      table {
        font-size: 0.75rem;
      }
      th, td {
        padding: 3px 4px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Inventaire produits – Le Vauban</h1>
  </header>

  <main>
    <p id="inv-info">Chargement de l’inventaire…</p>

    <table id="inv-table" style="display:none;">
      <thead>
        <tr>
          <th>Produit</th>
          <th>Fournisseur</th>
          <th style="text-align:right;">Prix HT</th>
          <th>Unité</th>
          <th style="text-align:right;">Stock</th>
          <th style="text-align:right;">Valeur stock</th>
          <th style="text-align:center;">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <th colspan="5" style="text-align:right;">TOTAL INVENTAIRE (€)</th>
          <th id="inv-total" style="text-align:right;"></th>
          <th></th>
        </tr>
      </tfoot>
    </table>

    <div class="add-row">
      <h2>Ajouter un produit</h2>
      <div class="add-row-fields">
        <input id="new-name" type="text" placeholder="Produit">
        <input id="new-supplier" type="text" placeholder="Fournisseur">
        <input id="new-price" type="number" step="0.01" placeholder="Prix HT">
        <input id="new-unit" type="text" placeholder="Unité">
        <input id="new-stock" type="number" step="0.01" placeholder="Stock">
        <button id="btn-add" class="btn-primary">Ajouter</button>
      </div>
      <p id="inv-msg"></p>
    </div>
  </main>

  <script>
    // ⚠️ Remplacer par l’URL EXACTE de ton WebApp Apps Script
    const API_URL = 'https://script.google.com/macros/s/AKfycbwoUtzG1-DlkSWNvaoDpR6xqH7azD0UkmKbWNo1BTD2fFAQlrwtGUilEjYrqNPikMbFHg/exec';

    let allProducts = [];

    async function loadInventory() {
      const info = document.getElementById('inv-info');
      const table = document.getElementById('inv-table');
      const tbody = table.querySelector('tbody');
      const totalCell = document.getElementById('inv-total');
      const msgEl = document.getElementById('inv-msg');

      msgEl.textContent = '';
      info.style.display = 'block';
      info.textContent = 'Chargement de l’inventaire…';
      table.style.display = 'none';
      tbody.innerHTML = '';
      totalCell.textContent = '';

      try {
        const res = await fetch(API_URL + '?type=inventory');
        const data = await res.json();

        if (!data || data.error) {
          info.textContent = 'Erreur : ' + (data && data.error ? data.error : 'réponse invalide');
          return;
        }

        allProducts = data.products || [];

        if (!allProducts.length) {
          info.textContent = 'Aucun produit trouvé.';
          return;
        }

        info.style.display = 'none';
        table.style.display = 'table';
        renderInventory(allProducts, data.totalInventory || 0);
      } catch (e) {
        console.error(e);
        info.textContent = 'Erreur de chargement de l’inventaire.';
      }
    }

    function renderInventory(products, totalInventory) {
      const table = document.getElementById('inv-table');
      const tbody = table.querySelector('tbody');
      const totalCell = document.getElementById('inv-total');

      tbody.innerHTML = '';

      products.forEach(p => {
        const tr = document.createElement('tr');

        function td(content, align) {
          const cell = document.createElement('td');
          if (content instanceof HTMLElement) {
            cell.appendChild(content);
          } else {
            cell.textContent = content;
          }
          if (align) cell.style.textAlign = align;
          return cell;
        }

        const priceInput = document.createElement('input');
        priceInput.type = 'number';
        priceInput.step = '0.01';
        priceInput.value = (p.priceHt != null ? p.priceHt : '');
        priceInput.style.textAlign = 'right';

        const unitInput = document.createElement('input');
        unitInput.type = 'text';
        unitInput.value = p.unit || '';

        const stockInput = document.createElement('input');
        stockInput.type = 'number';
        stockInput.step = '0.01';
        stockInput.value = (p.stock != null ? p.stock : '');
        stockInput.style.textAlign = 'right';

        const btnSave = document.createElement('button');
        btnSave.textContent = 'Enregistrer';
        btnSave.className = 'btn-primary';
        btnSave.onclick = () => saveProduct(
          p.row,
          p.name,
          p.supplier,
          priceInput.value,
          unitInput.value,
          stockInput.value
        );

        const btnDel = document.createElement('button');
        btnDel.textContent = 'Supprimer';
        btnDel.className = 'btn-ghost';
        btnDel.style.marginLeft = '4px';
        btnDel.onclick = () => deleteProduct(p.row, p.name);

        const actions = document.createElement('div');
        actions.appendChild(btnSave);
        actions.appendChild(btnDel);

        tr.appendChild(td(p.name, 'left'));
        tr.appendChild(td(p.supplier || '', 'left'));
        tr.appendChild(td(priceInput, 'right'));
        tr.appendChild(td(unitInput, 'left'));
        tr.appendChild(td(stockInput, 'right'));
        tr.appendChild(td(
          (p.stockValue != null && !isNaN(p.stockValue))
            ? Number(p.stockValue).toFixed(2)
            : '',
          'right'
        ));
        tr.appendChild(td(actions, 'center'));

        tbody.appendChild(tr);
      });

      totalCell.textContent = Number(totalInventory || 0).toFixed(2);
    }

    async function saveProduct(row, name, supplier, priceHt, unit, stock) {
      const msgEl = document.getElementById('inv-msg');
      msgEl.textContent = 'Enregistrement...';

      const params = new URLSearchParams();
      params.append('action', 'updateProduct');
      params.append('row', row);
      params.append('name', name);
      params.append('supplier', supplier || '');
      if (priceHt !== '') params.append('priceHt', priceHt);
      if (unit !== '')    params.append('unit', unit);
      if (stock !== '')   params.append('stock', stock);

      try {
        const res = await fetch(API_URL + '?' + params.toString()); // GET avec paramètres
        const data = await res.json();
        msgEl.textContent = 'Réponse: ' + JSON.stringify(data);
        if (data.error) {
          msgEl.textContent += ' | Erreur: ' + data.error;
        } else {
          msgEl.textContent += ' | OK produit mis à jour';
          loadInventory();
        }
      } catch (e) {
        console.error(e);
        msgEl.textContent = 'Erreur lors de la mise à jour.';
      }
    }

    async function deleteProduct(row, name) {
      const msgEl = document.getElementById('inv-msg');
      if (!confirm('Supprimer ce produit ?')) return;

      msgEl.textContent = 'Suppression...';

      const params = new URLSearchParams();
      params.append('action', 'deleteProduct');
      params.append('row', row);
      params.append('name', name);

      try {
        const res = await fetch(API_URL + '?' + params.toString());
        const data = await res.json();
        msgEl.textContent = 'Réponse: ' + JSON.stringify(data);
        if (data.error) {
          msgEl.textContent += ' | Erreur: ' + data.error;
        } else {
          msgEl.textContent += ' | OK produit supprimé';
          loadInventory();
        }
      } catch (e) {
        console.error(e);
        msgEl.textContent = 'Erreur lors de la suppression.';
      }
    }

    async function addNewProduct() {
      const msgEl = document.getElementById('inv-msg');
      const nameEl = document.getElementById('new-name');
      const supplierEl = document.getElementById('new-supplier');
      const priceEl = document.getElementById('new-price');
      const unitEl = document.getElementById('new-unit');
      const stockEl = document.getElementById('new-stock');

      if (!nameEl.value.trim()) {
        msgEl.textContent = 'Le nom du produit est obligatoire.';
        return;
      }

      msgEl.textContent = 'Ajout du produit...';

      const params = new URLSearchParams();
      params.append('action', 'addProduct');
      params.append('name', nameEl.value.trim());
      params.append('supplier', supplierEl.value.trim());
      if (priceEl.value !== '') params.append('priceHt', priceEl.value);
      if (unitEl.value !== '')  params.append('unit', unitEl.value);
      if (stockEl.value !== '') params.append('stock', stockEl.value);

      try {
        const res = await fetch(API_URL + '?' + params.toString());
        const data = await res.json();
        msgEl.textContent = 'Réponse: ' + JSON.stringify(data);
        if (data.error) {
          msgEl.textContent += ' | Erreur: ' + data.error;
        } else {
          msgEl.textContent += ' | OK produit ajouté';
          nameEl.value = '';
          supplierEl.value = '';
          priceEl.value = '';
          unitEl.value = '';
          stockEl.value = '';
          loadInventory();
        }
      } catch (e) {
        console.error(e);
        msgEl.textContent = 'Erreur lors de l’ajout.';
      }
    }

    document.getElementById('btn-add').addEventListener('click', addNewProduct);
    document.addEventListener('DOMContentLoaded', loadInventory);
  </script>
</body>
</html>
