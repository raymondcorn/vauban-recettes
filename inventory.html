<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Inventaire ‚Äì Vauban</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta name="theme-color" content="#222222">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <a href="index.html">‚Üê Recettes</a>
    <h1>Inventaire produits</h1>
  </header>

  <main>
    <section>
      <div style="display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:0.75rem;">
        <div>
          <label for="filter-supplier" style="font-size:0.85rem; display:block;">Fournisseur</label>
          <select id="filter-supplier">
            <option value="">Tous les fournisseurs</option>
          </select>
        </div>
        <div>
          <label for="search-product" style="font-size:0.85rem; display:block;">Rechercher produit</label>
          <input id="search-product" type="text" placeholder="Nom du produit‚Ä¶">
        </div>
      </div>

      <p id="inv-info">Chargement de l‚Äôinventaire‚Ä¶</p>

      <table id="inv-table" style="width:100%; border-collapse:collapse; display:none;">
        <thead>
          <tr>
            <th style="text-align:left; padding:4px;">Produit</th>
            <th style="text-align:left; padding:4px;">Fournisseur</th>
            <th style="text-align:right; padding:4px;">Prix HT</th>
            <th style="text-align:left; padding:4px;">Unit√©</th>
            <th style="text-align:right; padding:4px;">Stock</th>
            <th style="text-align:right; padding:4px;">Valeur stock</th>
            <th style="text-align:center; padding:4px;">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <th colspan="5" style="text-align:right; padding:4px;">TOTAL INVENTAIRE (‚Ç¨)</th>
            <th id="inv-total" style="text-align:right; padding:4px;"></th>
            <th></th>
          </tr>
        </tfoot>
      </table>
    </section>

    <section style="margin-top:2rem;">
      <h2>Ajouter un produit</h2>
      <div style="display:flex; flex-wrap:wrap; gap:0.5rem;">
        <input id="new-name" placeholder="Produit" />
        <input id="new-supplier" placeholder="Fournisseur" />
        <input id="new-price" type="number" step="0.01" placeholder="Prix HT" />
        <input id="new-unit" placeholder="Unit√©" />
        <input id="new-stock" type="number" step="0.01" placeholder="Stock" />
        <button id="btn-add">Ajouter</button>
      </div>
      <p id="inv-msg" style="margin-top:0.5rem; font-size:0.9rem;"></p>
    </section>
  </main>

  <script>
    // üîó URL de ton Apps Script
    const API_URL = 'https://script.google.com/macros/s/AKfycbwoUtzG1-DlkSWNvaoDpR6xqH7azD0UkmKbWNo1BTD2fFAQlrwtGUilEjYrqNPikMbFHg/exec'; // ‚Üê remplace par ton URL /exec
    

    let allProducts = []; // toutes les lignes r√©cup√©r√©es depuis l‚ÄôAPI

    async function loadInventory() {
      const info = document.getElementById('inv-info');
      const table = document.getElementById('inv-table');
      const tbody = table.querySelector('tbody');
      const totalCell = document.getElementById('inv-total');
      const supplierSelect = document.getElementById('filter-supplier');

      info.style.display = 'block';
      info.textContent = 'Chargement de l‚Äôinventaire‚Ä¶';
      table.style.display = 'none';
      tbody.innerHTML = '';
      totalCell.textContent = '';

      try {
        const res = await fetch(API_URL + '?type=inventory');
        const data = await res.json();

        if (data.error) {
          info.textContent = 'Erreur : ' + data.error;
          return;
        }

        allProducts = data.products || [];

        if (!allProducts.length) {
          info.textContent = 'Aucun produit trouv√©.';
          return;
        }

        // remplir la liste des fournisseurs
        const suppliers = Array.from(
          new Set(
            allProducts
              .map(p => p.supplier || '')
              .filter(s => s && s.trim() !== '')
          )
        ).sort((a, b) => a.localeCompare(b, 'fr'));

        supplierSelect.innerHTML = '<option value="">Tous les fournisseurs</option>';
        suppliers.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s;
          opt.textContent = s;
          supplierSelect.appendChild(opt);
        });

        info.style.display = 'none';
        table.style.display = 'table';

        // premier rendu sans filtre
        renderInventory();

      } catch (e) {
        console.error(e);
        info.textContent = 'Erreur de chargement de l‚Äôinventaire.';
      }
    }

    function renderInventory() {
      const table = document.getElementById('inv-table');
      const tbody = table.querySelector('tbody');
      const totalCell = document.getElementById('inv-total');
      const supplierSelect = document.getElementById('filter-supplier');
      const searchInput = document.getElementById('search-product');

      const supplierFilter = supplierSelect.value.trim().toLowerCase();
      const searchFilter = searchInput.value.trim().toLowerCase();

      tbody.innerHTML = '';

      const filtered = allProducts.filter(p => {
        const supplier = (p.supplier || '').toLowerCase();
        const name = (p.name || '').toLowerCase();

        if (supplierFilter && supplier !== supplierFilter) return false;
        if (searchFilter && !name.includes(searchFilter)) return false;
        return true;
      });

      let total = 0;

      filtered.forEach(p => {
        const tr = document.createElement('tr');

        function td(content, align) {
          const cell = document.createElement('td');
          if (content instanceof HTMLElement) {
            cell.appendChild(content);
          } else {
            cell.textContent = content;
          }
          cell.style.padding = '4px';
          if (align) cell.style.textAlign = align;
          return cell;
        }

        // champs √©ditables
        const priceInput = document.createElement('input');
        priceInput.type = 'number';
        priceInput.step = '0.01';
        priceInput.value = p.priceHt != null ? p.priceHt : '';
        priceInput.style.width = '80px';

        const unitInput = document.createElement('input');
        unitInput.type = 'text';
        unitInput.value = p.unit || '';
        unitInput.style.width = '70px';

        const stockInput = document.createElement('input');
        stockInput.type = 'number';
        stockInput.step = '0.01';
        stockInput.value = p.stock != null ? p.stock : '';
        stockInput.style.width = '70px';

        // boutons action
        const btnSave = document.createElement('button');
        btnSave.textContent = 'Enregistrer';
        btnSave.onclick = () => saveProduct(p.name, p.supplier, priceInput.value, unitInput.value, stockInput.value);

        const btnDel = document.createElement('button');
        btnDel.textContent = 'Supprimer';
        btnDel.style.marginLeft = '4px';
        btnDel.onclick = () => deleteProduct(p.name, p.supplier);

        const actions = document.createElement('div');
        actions.appendChild(btnSave);
        actions.appendChild(btnDel);

        const stockValue = p.stockValue != null && !isNaN(p.stockValue) ? Number(p.stockValue) : 0;
        total += stockValue;

        tr.appendChild(td(p.name, 'left'));
        tr.appendChild(td(p.supplier || '', 'left'));
        tr.appendChild(td(priceInput, 'right'));
        tr.appendChild(td(unitInput, 'left'));
        tr.appendChild(td(stockInput, 'right'));
        tr.appendChild(td(
          stockValue ? stockValue.toFixed(2) : '',
          'right'
        ));
        tr.appendChild(td(actions, 'center'));

        tbody.appendChild(tr);
      });

      totalCell.textContent = total.toFixed(2);
    }

    async function saveProduct(name, supplier, priceHt, unit, stock) {
      const msgEl = document.getElementById('inv-msg');
      msgEl.textContent = 'Enregistrement...';

      const params = new URLSearchParams();
      
      params.append('action', 'updateProduct');
      params.append('name', name);
      params.append('supplier', supplier);
      if (priceHt !== '') params.append('priceHt', priceHt);
      if (unit !== '')    params.append('unit', unit);
      if (stock !== '')   params.append('stock', stock);

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          body: params
        });
        const data = await res.json();
        if (data.error) {
          msgEl.textContent = 'Erreur : ' + data.error;
        } else {
          msgEl.textContent = 'Produit mis √† jour.';
          loadInventory();
        }
      } catch (e) {
        console.error(e);
        msgEl.textContent = 'Erreur lors de la mise √† jour.';
      }
    }

    async function deleteProduct(name, supplier) {
      const msgEl = document.getElementById('inv-msg');
      if (!confirm('Supprimer ce produit ?')) return;

      msgEl.textContent = 'Suppression...';

      const params = new URLSearchParams();
      
      params.append('action', 'deleteProduct');
      params.append('name', name);
      params.append('supplier', supplier);

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          body: params
        });
        const data = await res.json();
        if (data.error) {
          msgEl.textContent = 'Erreur : ' + data.error;
        } else {
          msgEl.textContent = 'Produit supprim√©.';
          loadInventory();
        }
      } catch (e) {
        console.error(e);
        msgEl.textContent = 'Erreur lors de la suppression.';
      }
    }

    async function addNewProduct() {
      const msgEl = document.getElementById('inv-msg');
      const nameEl = document.getElementById('new-name');
      const supplierEl = document.getElementById('new-supplier');
      const priceEl = document.getElementById('new-price');
      const unitEl = document.getElementById('new-unit');
      const stockEl = document.getElementById('new-stock');

      if (!nameEl.value.trim()) {
        msgEl.textContent = 'Le nom du produit est obligatoire.';
        return;
      }

      msgEl.textContent = 'Ajout du produit...';

      const params = new URLSearchParams();
      
      params.append('action', 'addProduct');
      params.append('name', nameEl.value.trim());
      params.append('supplier', supplierEl.value.trim());
      if (priceEl.value !== '') params.append('priceHt', priceEl.value);
      if (unitEl.value !== '')  params.append('unit', unitEl.value);
      if (stockEl.value !== '') params.append('stock', stockEl.value);

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          body: params
        });
        const data = await res.json();
        if (data.error) {
          msgEl.textContent = 'Erreur : ' + data.error;
        } else {
          msgEl.textContent = 'Produit ajout√©.';
          nameEl.value = '';
          supplierEl.value = '';
          priceEl.value = '';
          unitEl.value = '';
          stockEl.value = '';
          loadInventory();
        }
      } catch (e) {
        console.error(e);
        msgEl.textContent = 'Erreur lors de l‚Äôajout.';
      }
    }

    document.getElementById('btn-add').addEventListener('click', addNewProduct);
    document.getElementById('filter-supplier').addEventListener('change', renderInventory);
    document.getElementById('search-product').addEventListener('input', renderInventory);

    loadInventory();

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').catch(console.error);
    }
  </script>
</body>
</html>
