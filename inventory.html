<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Inventaire – Le Vauban</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      background: #0b1120;
      color: #e5e7eb;
    }
    header {
      padding: 12px;
      background: #020617;
      border-bottom: 1px solid #1f2937;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border-bottom: 1px solid #1f2937;
      padding: 6px;
    }
    th {
      background: #020617;
    }
    input {
      width: 100%;
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
      border-radius: 4px;
      padding: 4px;
    }
    button {
      padding: 4px 6px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-primary {
      background: #facc15;
      color: #111827;
    }
    .btn-delete {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }
  </style>
</head>
<body>
<header>
  <h1>Inventaire – Le Vauban</h1>
</header>

<p id="msg"></p>

<table id="table" style="display:none;">
  <thead>
    <tr>
      <th>Produit</th>
      <th>Fournisseur</th>
      <th>Prix HT</th>
      <th>Unité</th>
      <th>Stock</th>
      <th>Valeur</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr>
      <th colspan="5" style="text-align:right;">TOTAL (€)</th>
      <th id="total"></th>
      <th></th>
    </tr>
  </tfoot>
</table>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzqjrgxri0oLAPmi7WOR9ghp6ePiRGNqZsnprAijExaewLlto41o-jFnfk3mmLmEBFK/exec";

function setMsg(t) {
  document.getElementById("msg").textContent = t;
}

async function loadInventory() {
  setMsg("Chargement…");
  const res = await fetch(API_URL + "?type=inventory");
  const data = await res.json();

  if (!data || !data.products) {
    setMsg("Erreur de chargement inventaire");
    return;
  }

  const tbody = document.querySelector("#table tbody");
  tbody.innerHTML = "";
  document.getElementById("total").textContent = data.totalInventory.toFixed(2);
  document.getElementById("table").style.display = "table";

  data.products.forEach((p, index) => {
    const rowNum = index + 2; // Ligne réelle dans Sheets

    const tr = document.createElement("tr");

    function field(val, type="text") {
      const inp = document.createElement("input");
      inp.type = type;
      inp.value = val ?? "";
      return inp;
    }

    const priceInput = field(p.priceHt, "number");
    const unitInput = field(p.unit);
    const stockInput = field(p.stock, "number");

    const btnSave = document.createElement("button");
    btnSave.textContent = "Enregistrer";
    btnSave.className = "btn-primary";
    btnSave.onclick = () => saveProduct(rowNum, p.name, p.supplier, priceInput.value, unitInput.value, stockInput.value);

    const btnDel = document.createElement("button");
    btnDel.textContent = "Supprimer";
    btnDel.className = "btn-delete";
    btnDel.onclick = () => deleteProduct(rowNum);

    tr.innerHTML = `
      <td>${p.name}</td>
      <td>${p.supplier}</td>
    `;

    tr.appendChild(td(priceInput));
    tr.appendChild(td(unitInput));
    tr.appendChild(td(stockInput));

    const val = (p.priceHt * p.stock).toFixed(2);
    tr.appendChild(td(val));

    const actionTd = document.createElement("td");
    actionTd.appendChild(btnSave);
    actionTd.appendChild(btnDel);
    tr.appendChild(actionTd);

    tbody.appendChild(tr);
  });

  setMsg("");
}

function td(content) {
  const cell = document.createElement("td");
  if (content instanceof HTMLElement) cell.appendChild(content);
  else cell.textContent = content;
  return cell;
}

async function saveProduct(row, name, supplier, price, unit, stock) {
  setMsg("Enregistrement…");

  const url = API_URL + "?" + new URLSearchParams({
    action: "updateProduct",
    row,
    name,
    supplier,
    priceHt: price,
    unit,
    stock
  });

  const res = await fetch(url);
  const data = await res.json();

  if (data.ok) {
    setMsg("Produit mis à jour ✔️");
    loadInventory();
  } else {
    setMsg("Erreur update : " + data.error);
  }
}

async function deleteProduct(row) {
  if (!confirm("Supprimer ?")) return;

  const url = API_URL + "?" + new URLSearchParams({
    action: "deleteProduct",
    row
  });

  const res = await fetch(url);
  loadInventory();
}

loadInventory();
</script>

</body>
</html>
